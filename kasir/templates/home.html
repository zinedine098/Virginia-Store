{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-3">
  {% if messages %}
  <div class="alert alert-success">
    {% for message in messages %}
    {{ message }}
    {% endfor %}
  </div>
  {% endif %}
  <h4>ðŸ›’ Selamat Belanja</h4>
  <div class="row">
    <div class="col-md-8">
      <div class="row">
        {% for item in produk %}
        <div class="col-md-3 mb-3">
          <div class="card text-center" onclick="bukaDetail('{{ item.id }}', '{{ item.nama_barang }}', '{{ item.harga_barang }}', '{{ item.stok }}')">
            <img src="{{ item.gambar.url }}" class="card-img-top" style="height:180px; object-fit:cover;">
            <div class="card-body">
              <h6>{{ item.nama_barang }}</h6>
              <p>Rp. {{ item.harga_barang|floatformat:0 }}</p>
              <p>Stok: <span id="stok-{{ item.id }}">{{ item.stok }}</span></p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="col-md-4">
      <!-- Tabel Keranjang -->
      <h5 class="mt-4">ðŸ§¾ Keranjang Belanja</h5>
      <table class="table table-bordered" id="tabelKeranjang">
        <thead><tr><th>Barang</th><th>Harga</th><th>Jumlah</th><th>Subtotal</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="mt-3">
        <a href="{% url 'halaman_bayar' %}" class="btn btn-success">ðŸ’³ Bayar</a>
      </div>
    </div>
  </div>

  <!-- Modal Input Jumlah -->
  <div class="modal" id="modalProduk" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 id="namaProduk"></h5></div>
        <div class="modal-body">
          <p>Harga: Rp <span id="hargaProduk"></span></p>
          <p>Stok Tersedia: <span id="stokProduk"></span></p>
          <input type="number" id="jumlahBeli" class="form-control" placeholder="Masukkan jumlah" min="1">
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="tambahKeranjang()">Tambahkan</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let produkIdAktif = null;
let hargaAktif = 0;

document.addEventListener('DOMContentLoaded', function() {
  loadKeranjang();
});

async function loadKeranjang() {
  const response = await fetch("{% url 'get_keranjang' %}");
  const data = await response.json();
  const tbody = document.querySelector("#tabelKeranjang tbody");
  tbody.innerHTML = '';
  data.details.forEach(detail => {
    const row = `<tr data-produk="${detail.produk}" data-detail-id="${detail.detail_id}"><td>${detail.produk}</td><td>Rp ${detail.harga.toLocaleString()}</td><td><div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${detail.detail_id}, 'kurangi')">-</button><span class="mx-2">${detail.jumlah}</span><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${detail.detail_id}, 'tambah')">+</button></div></td><td>Rp ${detail.subtotal.toLocaleString()}</td><td><button class="btn btn-sm btn-danger" onclick="hapusItem(${detail.detail_id})">Hapus</button></td></tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
}

function bukaDetail(id, nama, harga, stok) {
  produkIdAktif = id;
  hargaAktif = harga;
  document.getElementById('namaProduk').textContent = nama;
  document.getElementById('hargaProduk').textContent = harga;
  document.getElementById('stokProduk').textContent = stok;
  document.getElementById('jumlahBeli').max = stok;
  new bootstrap.Modal(document.getElementById('modalProduk')).show();
}

async function tambahKeranjang() {
  const jumlah = document.getElementById('jumlahBeli').value;
  const response = await fetch("{% url 'tambah_ke_keranjang' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
    body: JSON.stringify({ produk_id: produkIdAktif, jumlah: jumlah })
  });
  const data = await response.json();

  if (data.status === "success") {
    const tbody = document.querySelector("#tabelKeranjang tbody");
    // Cek apakah produk sudah ada di tabel
    const existingRow = tbody.querySelector(`tr[data-produk="${data.produk}"]`);
    if (existingRow) {
      // Update jumlah dan subtotal jika sudah ada
      existingRow.cells[2].innerHTML = `<div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${data.detail_id}, 'kurangi')">-</button><span class="mx-2">${data.jumlah}</span><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${data.detail_id}, 'tambah')">+</button></div>`;
      existingRow.cells[3].textContent = `Rp ${data.subtotal.toLocaleString()}`;
    } else {
      // Tambah baris baru jika belum ada
      const row = `<tr data-produk="${data.produk}" data-detail-id="${data.detail_id}"><td>${data.produk}</td><td>Rp ${hargaAktif.toLocaleString()}</td><td><div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${data.detail_id}, 'kurangi')">-</button><span class="mx-2">${data.jumlah}</span><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${data.detail_id}, 'tambah')">+</button></div></td><td>Rp ${data.subtotal.toLocaleString()}</td><td><button class="btn btn-sm btn-danger" onclick="hapusItem(${data.detail_id})">Hapus</button></td></tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    }
    // Update stok di card
    document.getElementById(`stok-${produkIdAktif}`).textContent = data.new_stok;
    bootstrap.Modal.getInstance(document.getElementById('modalProduk')).hide();
  } else {
    alert(data.message || "Stok tidak cukup!");
  }
}

async function updateJumlah(detailId, action) {
  const response = await fetch("{% url 'update_jumlah' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
    body: JSON.stringify({ detail_id: detailId, action: action })
  });
  const data = await response.json();

  if (data.status === "success") {
    const row = document.querySelector(`tr[data-detail-id="${detailId}"]`);
    row.cells[2].innerHTML = `<div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${detailId}, 'kurangi')">-</button><span class="mx-2">${data.jumlah}</span><button class="btn btn-sm btn-secondary" onclick="updateJumlah(${detailId}, 'tambah')">+</button></div>`;
    row.cells[3].textContent = `Rp ${data.subtotal.toLocaleString()}`;
    // Update stok di card
    document.getElementById(`stok-${data.produk_id}`).textContent = data.new_stok;
  }
}

async function hapusItem(detailId) {
  const response = await fetch("{% url 'hapus_item' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
    body: JSON.stringify({ detail_id: detailId })
  });
  const data = await response.json();

  if (data.status === "success") {
    const row = document.querySelector(`tr[data-detail-id="${detailId}"]`);
    row.remove();
    // Update stok di card
    document.getElementById(`stok-${data.produk_id}`).textContent = data.new_stok;
  }
}
</script>
{% endblock %}
