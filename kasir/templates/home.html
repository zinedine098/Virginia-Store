{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}

<!-- Tambahkan Font Awesome jika belum ada di base.html, tapi sebaiknya di base.html saja -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> -->

<style>
  #hitam {
    color: rgb(44, 44, 44);
  }
  /* ================== STYLING KONTEN UTAMA ================== */
  /* Area konten produk */
  .content-area {
    padding: 10px 400px 20px 20px; /* Kurangi padding atas, tambah kanan untuk sidebar fixed */
  }

  /* ================== STYLING PRODUK CARD ================== */
  .product-card {
    background-color: #ffffff;
    /* border: 1px solid #f8f9fa; */
    color: #212529;
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    cursor: pointer;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    /* border-color: #007bff; */
  }
  .product-card .card-img-top {
    border-top-left-radius: calc(0.375rem - 1px);
    border-top-right-radius: calc(0.375rem - 1px);
  }
  .product-card .card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .product-card .card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 0.5rem;
  }
  .product-card .price {
    font-weight: 700;
    font-size: 1.1rem;
    color: #007bff;
    margin: 0;
  }
  .product-card .stock {
    font-size: 0.85rem;
    color: #5a5a5a;
    margin: 0;
  }

  /* ================== STYLING MODE TOGGLE ================== */
  .mode-toggle-container {
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 5px;
    display: inline-block;
    border: 1px solid #f8f9fa;
  }
  .mode-toggle-container .btn {
    border: none;
    font-weight: 500;
  }
  .mode-toggle-container .btn-primary {
    background-color: #007bff;
  }
  .mode-toggle-container .btn-secondary {
    background-color: transparent;
    color: #6c757d;
  }
  .mode-toggle-container .btn-secondary:hover {
    background-color: #f8f9fa;
    color: #212529;
  }

  /* ================== STYLING BARCODE MODE ================== */
  .barcode-form-container {
    max-width: 500px;
    margin: 40px 0;
  }
  .barcode-form-container .card {
    background-color: #e9ecef;
    border: 1px solid #f8f9fa;
  }
  .barcode-form-container .form-control {
    font-size: 1.1rem;
    padding: 12px 15px;
  }

  /* ================== STYLING SIDEBAR KERANJANG ================== */
  .cart-sidebar {
    position: fixed;
    right: 0;
    top: 56px; /* Adjust to be below the navbar (assuming navbar height is 56px) */
    height: calc(100vh - 56px); /* Adjust height to account for navbar */
    width: 380px;
    background-color: #ffffff;
    color: #212529;
    display: flex;
    flex-direction: column;
    flex-shrink: 0; /* Mencegah sidebar menyusut */
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease;
    z-index: 1000;
  }
  .cart-header {
    padding: 15px 20px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
  }
  .cart-header h5 {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
  }
  .cart-items {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
  }
  .cart-items::-webkit-scrollbar { width: 8px; }
  .cart-items::-webkit-scrollbar-track { background: #ffffff; }
  .cart-items::-webkit-scrollbar-thumb { background-color: #e9ecef; border-radius: 4px; }
  .empty-cart {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    padding: 20px;
    text-align: center;
  }
  .empty-cart i { font-size: 3rem; margin-bottom: 15px; }
  .cart-item {
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    animation: slideIn 0.3s ease-out;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  .cart-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .cart-item-name {
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 70%;
  }
  .cart-item-price { color: #6c757d; font-size: 0.9rem; }
  .cart-item-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .quantity-control {
    display: flex;
    align-items: center;
    background-color: #f8f9fa;
    border-radius: 5px;
  }
  .quantity-btn {
    background-color: transparent;
    border: none;
    color: #212529;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.2s;
  }
  .quantity-btn:hover { background-color: #ffffff; }
  .quantity-value {
    margin: 0 12px;
    font-weight: 500;
    min-width: 20px;
    text-align: center;
  }
  .cart-item-subtotal {
    font-weight: 600;
    color: #007bff;
    margin-right: 10px;
  }
  .delete-btn {
    background-color: #dc3545;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .delete-btn:hover { background-color: #c0392b; }
  .cart-footer {
    padding: 15px 20px;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
    flex-shrink: 0;
  }
  .cart-total h5 { margin: 0; font-weight: 600; }
  /* .cart-footer .btn-success {
    background-color: #007bff;
    border-color: #007bff;
    font-weight: 600;
    padding: 10px;
    font-size: 1rem;
    transition: background-color 0.2s;
  } */
  .cart-footer .btn-success:hover { background-color: #326b37; border-color: #0056b3; }

  /* ================== STYLING MODAL ================== */
  .modal-content {
    background-color: #e9ecef;
    color: #212529;
    border: 1px solid #f8f9fa;
  }
  .modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #ffffff;
  }
  .modal-header .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
  }
  .modal-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #ffffff;
  }

  /* ================== RESPONSIVE ================== */
  @media (max-width: 992px) {
    .cart-sidebar { width: 320px; }
    .content-area { padding-right: 5px; }
  }
  @media (max-width: 768px) {
    .main-container { flex-direction: column; }
    .cart-sidebar {
      width: 100%;
      height: auto;
      margin-top: 20px;
    }
    .content-area { padding-right: 20px; }
  }
</style>

<div class="main-container">
  <!-- Area Konten Utama (Kiri) -->
  <div class="content-area">
    {% if messages %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {% for message in messages %}
      {{ message }}
      {% endfor %}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}  
    <!-- Tombol Toggle Mode -->
        <div class="input-group mb-3">
          <span class="input-group-text"><i class="fas fa-barcode"></i></span>
          <input type="text" id="barcodeInput" class="form-control" placeholder="Masukan barcode" onkeypress="if(event.key === 'Enter'){cariProdukByBarcode()}">
          <button class="btn btn-warning" onclick="cariProdukByBarcode()">
            <i class="fas fa-search me-2"></i>
          </button>
        </div>

    <!-- Mode Card -->
    <div id="cardMode">
      <div class="row g-3">
        {% for item in produk %}
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card product-card" onclick="bukaDetail('{{ item.id }}', '{{ item.nama_barang }}', '{{ item.harga_barang }}', '{{ item.stok }}', '{{ item.gambar.url }}')">
            <img src="{{ item.gambar.url }}" class="card-img-top" style="height:250px; object-fit:cover;" alt="{{ item.nama_barang }}">
            <div class="card-body">
              <h6 class="card-title">{{ item.nama_barang }}</h6>
              <div>
                <p class="price" id="hitam">Rp. {{ item.harga_barang|floatformat:0|intcomma }}</p>
                <p class="stock">Stok: <span id="stok-{{ item.id }}">{{ item.stok }}</span></p>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Mode Barcode -->
    <div id="barcodeMode" style="display: none;">
      <div class="barcode-form-container">
        <div class="card p-4">
          <h5 class="text-center mb-4">Cari Produk dengan Barcode</h5>
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="fas fa-barcode"></i></span>
            <input type="text" id="barcodeInput" class="form-control" placeholder="Masukkan barcode..." onkeypress="if(event.key === 'Enter'){cariProdukByBarcode()}">
          </div>
          <button class="btn btn-primary w-100" onclick="cariProdukByBarcode()">
            <i class="fas fa-search me-2"></i> Cari Produk
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== SIDEBAR KERANJANG ================== -->
  <div class="cart-sidebar">
    <div class="cart-header">
      <h5><i class="fas fa-shopping-cart me-2"></i> Keranjang Belanja</h5>
    </div>
    <div class="cart-items" id="cartItems" style="margin-top: 20px;">
      <div class="empty-cart" id="emptyCart">
        <i class="fas fa-shopping-basket"></i>
        <p>Keranjang belanja kosong</p>
        <small>Pilih produk untuk memulai</small>
      </div>
    </div>
    <div class="cart-footer">
      <div class="cart-total d-flex justify-content-between align-items-center">
        <h5>Total:</h5>
        <h5 id="totalBayar">Rp 0</h5>
      </div>
      <div class="cart-action mt-3">
        <a href="{% url 'halaman_bayar' %}" class="btn btn-success w-100"><i class="fas fa-credit-card me-2"></i> Bayar</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal Input Jumlah -->
<div class="modal fade" id="modalProduk" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="namaProduk"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="gambarProduk" src="" alt="Product Image" class="img-fluid mb-3" style="max-height: 200px; display: block; margin: auto; border-radius: 8px;">
        <p>Harga: <strong>Rp <span id="hargaProduk"></span></strong></p>
        <p>Stok Tersedia: <span id="stokProduk"></span></p>
        <div class="input-group mb-3">
          <span class="input-group-text">Jumlah</span>
          <input type="number" id="jumlahBeli" class="form-control" placeholder="Masukkan jumlah" min="1" value="1">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" onclick="tambahKeranjang()"><i class="fas fa-plus me-1"></i> Tambahkan</button>
      </div>
    </div>
  </div>
</div>

<script>
let produkIdAktif = null;
let hargaAktif = 0;

document.addEventListener('DOMContentLoaded', function() {
  loadKeranjang();
});

async function loadKeranjang() {
  try {
    const response = await fetch("{% url 'get_keranjang' %}");
    const data = await response.json();
    renderCartItems(data.details);
    calculateTotal();
  } catch (error) {
    console.error("Gagal memuat keranjang:", error);
    document.getElementById('cartItems').innerHTML = '<p class="text-center text-danger">Gagal memuat keranjang.</p>';
  }
}

function renderCartItems(details) {
  const cartItemsContainer = document.getElementById('cartItems');
  if (details.length === 0) {
    cartItemsContainer.innerHTML = `
      <div class="empty-cart" id="emptyCart">
        <i class="fas fa-shopping-basket"></i>
        <p>Keranjang belanja kosong</p>
        <small>Pilih produk untuk memulai</small>
      </div>
    `;
    return;
  }
  cartItemsContainer.innerHTML = '';
  details.forEach(detail => {
    const itemElement = document.createElement('div');
    itemElement.className = 'cart-item';
    itemElement.setAttribute('data-detail-id', detail.detail_id);
    itemElement.innerHTML = `
      <div class="cart-item-header">
        <div class="cart-item-name" title="${detail.produk}">${detail.produk}</div>
        <div class="cart-item-price">Rp ${detail.harga.toLocaleString('id-ID')}</div>
      </div>
      <div class="cart-item-details">
        <div class="quantity-control">
          <button class="quantity-btn" onclick="updateJumlah(${detail.detail_id}, 'kurangi')"><i class="fas fa-minus"></i></button>
          <span class="quantity-value">${detail.jumlah}</span>
          <button class="quantity-btn" onclick="updateJumlah(${detail.detail_id}, 'tambah')"><i class="fas fa-plus"></i></button>
        </div>
        <div class="cart-item-subtotal">Rp ${detail.subtotal.toLocaleString('id-ID')}</div>
        <button class="delete-btn" onclick="hapusItem(${detail.detail_id})" title="Hapus Item">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
    cartItemsContainer.appendChild(itemElement);
  });
}

function bukaDetail(id, nama, harga, stok, gambar) {
  produkIdAktif = id;
  hargaAktif = harga;
  document.getElementById('namaProduk').textContent = nama;
  document.getElementById('hargaProduk').textContent = parseInt(harga).toLocaleString('id-ID');
  document.getElementById('stokProduk').textContent = stok;
  const jumlahInput = document.getElementById('jumlahBeli');
  jumlahInput.max = stok;
  jumlahInput.value = 1;
  const imgElement = document.getElementById('gambarProduk');
  if (gambar) {
    imgElement.src = gambar;
    imgElement.style.display = 'block';
  } else {
    imgElement.style.display = 'none';
  }
  new bootstrap.Modal(document.getElementById('modalProduk')).show();
}

async function tambahKeranjang() {
  const jumlah = parseInt(document.getElementById('jumlahBeli').value);
  if (!jumlah || jumlah < 1) {
    alert('Masukkan jumlah yang valid!');
    return;
  }
  try {
    const response = await fetch("{% url 'tambah_ke_keranjang' %}", {
      method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ produk_id: produkIdAktif, jumlah: jumlah })
    });
    const data = await response.json();
    if (data.status === "success") {
      const stokElement = document.getElementById(`stok-${produkIdAktif}`);
      if(stokElement) stokElement.textContent = data.new_stok;
      loadKeranjang();
      bootstrap.Modal.getInstance(document.getElementById('modalProduk')).hide();
    } else {
      alert(data.message || "Gagal menambahkan ke keranjang.");
    }
  } catch (error) {
    console.error("Error adding to cart:", error);
    alert("Terjadi kesalahan saat menambahkan produk.");
  }
}

async function updateJumlah(detailId, action) {
  try {
    const response = await fetch("{% url 'update_jumlah' %}", {
      method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ detail_id: detailId, action: action })
    });
    const data = await response.json();
    if (data.status === "success") {
      const stokElement = document.getElementById(`stok-${data.produk_id}`);
      if(stokElement) stokElement.textContent = data.new_stok;
      loadKeranjang();
    } else {
      alert(data.message || "Gagal memperbarui jumlah.");
    }
  } catch (error) {
    console.error("Error updating quantity:", error);
    alert("Terjadi kesalahan saat memperbarui jumlah.");
  }
}

async function hapusItem(detailId) {
  if (!confirm('Apakah Anda yakin ingin menghapus item ini?')) return;
  try {
    const response = await fetch("{% url 'hapus_item' %}", {
      method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ detail_id: detailId })
    });
    const data = await response.json();
    if (data.status === "success") {
      const stokElement = document.getElementById(`stok-${data.produk_id}`);
      if(stokElement) stokElement.textContent = data.new_stok;
      loadKeranjang();
    } else {
      alert(data.message || "Gagal menghapus item.");
    }
  } catch (error) {
    console.error("Error deleting item:", error);
    alert("Terjadi kesalahan saat menghapus item.");
  }
}

function calculateTotal() {
  const cartItems = document.querySelectorAll('.cart-item');
  let total = 0;
  cartItems.forEach(item => {
    const subtotalText = item.querySelector('.cart-item-subtotal').textContent.replace('Rp ', '').replace(/\./g, '');
    const subtotal = parseInt(subtotalText) || 0;
    total += subtotal;
  });
  document.getElementById('totalBayar').textContent = `Rp ${total.toLocaleString('id-ID')}`;
}

function toggleMode(mode) {
  const cardMode = document.getElementById('cardMode');
  const barcodeMode = document.getElementById('barcodeMode');
  if (mode === 'card') {
    cardMode.style.display = 'block';
    barcodeMode.style.display = 'none';
  } else {
    cardMode.style.display = 'none';
    barcodeMode.style.display = 'block';
    document.getElementById('barcodeInput').focus();
  }
}

async function cariProdukByBarcode() {
  const barcode = document.getElementById('barcodeInput').value.trim();
  if (!barcode) { alert('Masukkan barcode terlebih dahulu!'); return; }
  try {
    const response = await fetch(`{% url 'get_produk_by_barcode' %}?barcode=${encodeURIComponent(barcode)}`);
    const data = await response.json();
    if (data.status === 'success') {
      toggleMode('card');
      bukaDetail(data.id, data.nama_barang, data.harga_barang, data.stok, data.gambar);
    } else {
      alert(data.message || 'Produk dengan barcode tersebut tidak ditemukan.');
    }
  } catch (error) {
    console.error("Error fetching product by barcode:", error);
    alert("Terjadi kesalahan saat mencari produk.");
  }
}
</script>
{% endblock %}