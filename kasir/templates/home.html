{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-3">
  {% if messages %}
  <div class="alert alert-success">
    {% for message in messages %}
    {{ message }}
    {% endfor %}
  </div>
  {% endif %}
  <h4>ðŸ›’ Selamat Belanja</h4>
  <div class="mb-3">
    <button class="btn btn-primary me-2" onclick="toggleMode('card')">Pilih Produk via Card</button>
    <button class="btn btn-secondary" onclick="toggleMode('barcode')">Input Barcode</button>
  </div>
  <div id="cardMode" class="row">
    <div class="col-md-8">
      <div class="row">
        {% for item in produk %}
        <div class="col-md-3 mb-3">
          <div class="card text-center" onclick="bukaDetail('{{ item.id }}', '{{ item.nama_barang }}', '{{ item.harga_barang }}', '{{ item.stok }}')">
            <img src="{{ item.gambar.url }}" class="card-img-top" style="height:180px; object-fit:cover;">
            <div class="card-body">
              <h6>{{ item.nama_barang }}</h6>
              <p>Rp. {{ item.harga_barang|floatformat:0 }}</p>
              <p>Stok: <span id="stok-{{ item.id }}">{{ item.stok }}</span></p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="col-md-4 cart-sticky">
      <!-- Tabel Keranjang -->
      <h5 class="mt-4">Keranjang Belanja</h5>
      <table class="table table-striped table-hover table-bordered" id="tabelKeranjang">
        <thead><tr><th>Barang</th><th>Harga</th><th>Jumlah</th><th>Subtotal</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="mt-3 text-end">
        <h5>Total: Rp <span id="totalBayar">0</span></h5>
      </div>
      <div class="mt-3">
        <a href="{% url 'halaman_bayar' %}" class="btn btn-success">ðŸ’³ Bayar</a>
      </div>
    </div>
  </div>

  <div id="barcodeMode" class="row" style="display: none;">
    <div class="col-md-8">
      <div class="mb-3">
        <input type="text" id="barcodeInput" class="form-control" placeholder="Masukkan barcode produk">
        <button class="btn btn-primary mt-2" onclick="cariProdukByBarcode()">Cari Produk</button>
      </div>
    </div>
    <div class="col-md-4 cart-sticky">
      <!-- Tabel Keranjang -->
      <h5 class="mt-4">Keranjang Belanja</h5>
      <table class="table table-striped table-hover table-bordered" id="tabelKeranjangBarcode">
        <thead><tr><th>Barang</th><th>Harga</th><th>Jumlah</th><th>Subtotal</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="mt-3 text-end">
        <h5>Total: Rp <span id="totalBayarBarcode">0</span></h5>
      </div>
      <div class="mt-3">
        <a href="{% url 'halaman_bayar' %}" class="btn btn-success">ðŸ’³ Bayar</a>
      </div>
    </div>
  </div>

  <!-- Modal Input Jumlah -->
  <div class="modal" id="modalProduk" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 id="namaProduk"></h5></div>
        <div class="modal-body">
          <img id="gambarProduk" src="" alt="Product Image" class="img-fluid mb-3" style="max-height: 200px; display: none;">
          <p>Harga: Rp <span id="hargaProduk"></span></p>
          <p>Stok Tersedia: <span id="stokProduk"></span></p>
          <input type="number" id="jumlahBeli" class="form-control" placeholder="Masukkan jumlah" min="1">
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="tambahKeranjang()">Tambahkan</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let produkIdAktif = null;
let hargaAktif = 0;

document.addEventListener('DOMContentLoaded', function() {
  loadKeranjang();
});

async function loadKeranjang() {
  const response = await fetch("{% url 'get_keranjang' %}");
  const data = await response.json();
  const tbody = document.querySelector("#tabelKeranjang tbody");
  tbody.innerHTML = '';
  data.details.forEach(detail => {
    const row = `<tr data-produk="${detail.produk}" data-detail-id="${detail.detail_id}"><td>${detail.produk}</td><td>Rp ${detail.harga.toLocaleString('id-ID')}</td><td><div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${detail.detail_id}, 'kurangi')">-</button><span class="mx-2">${detail.jumlah}</span><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${detail.detail_id}, 'tambah')">+</button></div></td><td>Rp ${detail.subtotal.toLocaleString('id-ID')}</td><td><button class="btn btn-sm btn-outline-danger" onclick="hapusItem(${detail.detail_id})">Hapus</button></td></tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
  calculateTotal();
}

function bukaDetail(id, nama, harga, stok, gambar = '') {
  produkIdAktif = id;
  hargaAktif = harga;
  document.getElementById('namaProduk').textContent = nama;
  document.getElementById('hargaProduk').textContent = harga;
  document.getElementById('stokProduk').textContent = stok;
  document.getElementById('jumlahBeli').max = stok;
  const imgElement = document.getElementById('gambarProduk');
  if (gambar) {
    imgElement.src = gambar;
    imgElement.style.display = 'block';
  } else {
    imgElement.style.display = 'none';
  }
  new bootstrap.Modal(document.getElementById('modalProduk')).show();
}

async function tambahKeranjang() {
  const jumlah = document.getElementById('jumlahBeli').value;
  const response = await fetch("{% url 'tambah_ke_keranjang' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
    body: JSON.stringify({ produk_id: produkIdAktif, jumlah: jumlah })
  });
  const data = await response.json();

  if (data.status === "success") {
    const currentMode = document.getElementById('cardMode').style.display !== 'none' ? 'card' : 'barcode';
    const tbody = currentMode === 'card' ? document.querySelector("#tabelKeranjang tbody") : document.querySelector("#tabelKeranjangBarcode tbody");
    // Cek apakah produk sudah ada di tabel
    const existingRow = tbody.querySelector(`tr[data-produk="${data.produk}"]`);
    if (existingRow) {
      // Update jumlah dan subtotal jika sudah ada
      existingRow.cells[2].innerHTML = `<div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${data.detail_id}, 'kurangi')">-</button><span class="mx-2">${data.jumlah}</span><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${data.detail_id}, 'tambah')">+</button></div>`;
      existingRow.cells[3].textContent = `Rp ${data.subtotal.toLocaleString('id-ID')}`;
    } else {
      // Tambah baris baru jika belum ada
      const row = `<tr data-produk="${data.produk}" data-detail-id="${data.detail_id}"><td>${data.produk}</td><td>Rp ${hargaAktif.toLocaleString('id-ID')}</td><td><div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${data.detail_id}, 'kurangi')">-</button><span class="mx-2">${data.jumlah}</span><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${data.detail_id}, 'tambah')">+</button></div></td><td>Rp ${data.subtotal.toLocaleString('id-ID')}</td><td><button class="btn btn-sm btn-outline-danger" onclick="hapusItem(${data.detail_id})">Hapus</button></td></tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    }
    // Update stok di card
    document.getElementById(`stok-${produkIdAktif}`).textContent = data.new_stok;
    bootstrap.Modal.getInstance(document.getElementById('modalProduk')).hide();
    if (currentMode === 'card') {
      calculateTotal();
    } else {
      calculateTotalBarcode();
    }
  } else {
    alert(data.message || "Stok tidak cukup!");
  }
}

async function updateJumlah(detailId, action) {
  const response = await fetch("{% url 'update_jumlah' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
    body: JSON.stringify({ detail_id: detailId, action: action })
  });
  const data = await response.json();

  if (data.status === "success") {
    const row = document.querySelector(`tr[data-detail-id="${detailId}"]`);
    row.cells[2].innerHTML = `<div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${detailId}, 'kurangi')">-</button><span class="mx-2">${data.jumlah}</span><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${detailId}, 'tambah')">+</button></div>`;
    row.cells[3].textContent = `Rp ${data.subtotal.toLocaleString('id-ID')}`;
    // Update stok di card
    document.getElementById(`stok-${data.produk_id}`).textContent = data.new_stok;
    const currentMode = document.getElementById('cardMode').style.display !== 'none' ? 'card' : 'barcode';
    if (currentMode === 'card') {
      calculateTotal();
    } else {
      calculateTotalBarcode();
    }
  }
}

async function hapusItem(detailId) {
  const response = await fetch("{% url 'hapus_item' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
    body: JSON.stringify({ detail_id: detailId })
  });
  const data = await response.json();

  if (data.status === "success") {
    const row = document.querySelector(`tr[data-detail-id="${detailId}"]`);
    row.remove();
    // Update stok di card
    document.getElementById(`stok-${data.produk_id}`).textContent = data.new_stok;
    const currentMode = document.getElementById('cardMode').style.display !== 'none' ? 'card' : 'barcode';
    if (currentMode === 'card') {
      calculateTotal();
    } else {
      calculateTotalBarcode();
    }
  }
}

function calculateTotal() {
  const rows = document.querySelectorAll("#tabelKeranjang tbody tr");
  let total = 0;
  rows.forEach(row => {
    const subtotalText = row.cells[3].textContent.replace('Rp ', '').replace(/\./g, '');
    const subtotal = parseInt(subtotalText) || 0;
    total += subtotal;
  });
  document.getElementById('totalBayar').textContent = total.toLocaleString('id-ID');
}

function toggleMode(mode) {
  if (mode === 'card') {
    document.getElementById('cardMode').style.display = 'flex';
    document.getElementById('barcodeMode').style.display = 'none';
  } else if (mode === 'barcode') {
    document.getElementById('cardMode').style.display = 'none';
    document.getElementById('barcodeMode').style.display = 'flex';
    loadKeranjangBarcode();
  }
}

async function loadKeranjangBarcode() {
  const response = await fetch("{% url 'get_keranjang' %}");
  const data = await response.json();
  const tbody = document.querySelector("#tabelKeranjangBarcode tbody");
  tbody.innerHTML = '';
  data.details.forEach(detail => {
    const row = `<tr data-produk="${detail.produk}" data-detail-id="${detail.detail_id}"><td>${detail.produk}</td><td>Rp ${detail.harga.toLocaleString('id-ID')}</td><td><div class="d-flex align-items-center justify-content-center"><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${detail.detail_id}, 'kurangi')">-</button><span class="mx-2">${detail.jumlah}</span><button class="btn btn-sm btn-outline-secondary" onclick="updateJumlah(${detail.detail_id}, 'tambah')">+</button></div></td><td>Rp ${detail.subtotal.toLocaleString('id-ID')}</td><td><button class="btn btn-sm btn-outline-danger" onclick="hapusItem(${detail.detail_id})">Hapus</button></td></tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
  calculateTotalBarcode();
}

async function cariProdukByBarcode() {
  const barcode = document.getElementById('barcodeInput').value;
  if (!barcode) {
    alert('Masukkan barcode!');
    return;
  }
  const response = await fetch(`{% url 'get_produk_by_barcode' %}?barcode=${barcode}`);
  const data = await response.json();
  if (data.status === 'success') {
    bukaDetail(data.id, data.nama_barang, data.harga_barang, data.stok, data.gambar);
  } else {
    alert(data.message);
  }
}

function calculateTotalBarcode() {
  const rows = document.querySelectorAll("#tabelKeranjangBarcode tbody tr");
  let total = 0;
  rows.forEach(row => {
    const subtotalText = row.cells[3].textContent.replace('Rp ', '').replace(/\./g, '');
    const subtotal = parseInt(subtotalText) || 0;
    total += subtotal;
  });
  document.getElementById('totalBayarBarcode').textContent = total.toLocaleString('id-ID');
}
</script>
{% endblock %}
